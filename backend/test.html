<?php
session_start();
include 'db_connection.php';

if (!isset($_SESSION["User_ID"])) {
    header("Location: index.php");
    exit();
}

$loggedInID = $_SESSION["User_ID"];
$dateFilter = $_GET['date'] ?? '';
$statusFilter = $_GET['status'] ?? '';

$filterSQL = "";
if (!empty($dateFilter)) $filterSQL .= " AND t.Date = '$dateFilter'";
if (!empty($statusFilter)) $filterSQL .= " AND t.trip_status = '$statusFilter'";

$ownTripsQuery = "
    SELECT t.*, u.Name, pv.Vehicle_Type, pv.Model_Name, pv.Vehicle_Number
    FROM Trips t
    LEFT JOIN User u ON t.Student_ID = u.Student_ID
    LEFT JOIN Private_Vehicle pv ON pv.Owner_ID = t.Student_ID
    WHERE t.Student_ID = '$loggedInID' $filterSQL
";

$joinedTripsQuery = "
    SELECT t.*, u.Name, pv.Vehicle_Type, pv.Model_Name, pv.Vehicle_Number
    FROM Trips t
    JOIN Trip_Joiners tj ON t.Trip_ID = tj.Trip_ID
    LEFT JOIN User u ON t.Student_ID = u.Student_ID
    LEFT JOIN Private_Vehicle pv ON pv.Owner_ID = t.Student_ID
    WHERE tj.Student_ID = '$loggedInID' $filterSQL
";

$ownTripsResult = mysqli_query($conn, $ownTripsQuery);
$joinedTripsResult = mysqli_query($conn, $joinedTripsQuery);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trip History</title>
    <link rel="stylesheet" href="css\trip_history.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<h1><i class="fas fa-route"></i> Trip History</h1>

<div class="filters">
    <form method="get">
        <input type="date" name="date" value="<?= htmlspecialchars($dateFilter) ?>">
        <select name="status">
            <option value="">All Status</option>
            <option value="Available" <?= $statusFilter === 'Available' ? 'selected' : '' ?>>Available</option>
            <option value="Completed" <?= $statusFilter === 'Completed' ? 'selected' : '' ?>>Completed</option>
            <option value="Cancelled" <?= $statusFilter === 'Cancelled' ? 'selected' : '' ?>>Cancelled</option>
        </select>
        <button type="submit"><i class="fas fa-filter"></i> Filter</button>
    </form>
</div>

<div class="button-group">
    <button onclick="window.print()" class="print-btn"><i class="fas fa-file-pdf"></i> Download / Print</button>
</div>

<h2><i class="fas fa-car-side"></i> Trips You Created</h2>
<div class="history-container">
    <?php while ($trip = mysqli_fetch_assoc($ownTripsResult)) { ?>
        <div class="history-card">
            <div class="badge <?= $trip['trip_status'] ?>"><?= $trip['trip_status'] ?></div>
            <strong>Trip ID:</strong> <?= $trip['Trip_ID'] ?><br>
            <strong>Rider:</strong> <?= $trip['Name'] ?><br>
            <strong>Vehicle:</strong> <?= $trip['Vehicle_Type'] ?> - <?= $trip['Model_Name'] ?> (<?= $trip['Vehicle_Number'] ?>)<br>
            <strong>From:</strong> <?= $trip['where_loc'] ?> <strong>To:</strong> <?= $trip['to_loc'] ?><br>
            <strong>Date:</strong> <?= $trip['Date'] ?> <strong>Time:</strong> <?= $trip['Time'] ?><br>
            <strong>Fare:</strong> <?= $trip['Fare'] ?> BDT<br>
            <strong>Mode:</strong> <?= $trip['Mode_of_Commute'] ?><br>
        </div>
    <?php } ?>
</div>

<h2><i class="fas fa-users"></i> Trips You Joined</h2>
<div class="history-container">
    <?php while ($trip = mysqli_fetch_assoc($joinedTripsResult)) { ?>
        <div class="history-card">
            <div class="badge <?= $trip['trip_status'] ?>"><?= $trip['trip_status'] ?></div>
            <strong>Trip ID:</strong> <?= $trip['Trip_ID'] ?><br>
            <strong>Rider:</strong> <?= $trip['Name'] ?><br>
            <strong>Vehicle:</strong> <?= $trip['Vehicle_Type'] ?> - <?= $trip['Model_Name'] ?> (<?= $trip['Vehicle_Number'] ?>)<br>
            <strong>From:</strong> <?= $trip['where_loc'] ?> <strong>To:</strong> <?= $trip['to_loc'] ?><br>
            <strong>Date:</strong> <?= $trip['Date'] ?> <strong>Time:</strong> <?= $trip['Time'] ?><br>
            <strong>Fare:</strong> <?= $trip['Fare'] ?> BDT<br>
            <strong>Mode:</strong> <?= $trip['Mode_of_Commute'] ?><br>
        </div>
    <?php } ?>
</div>

</body>
</html>